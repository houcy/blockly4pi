<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Generating Python</title>
  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="python_compressed.js"></script>
  <script src="zh-hans.js"></script>

  <!--pi core-->
  <script src="blocks.js"></script>

  <!--alert plugin-->
  <link rel="stylesheet" href="http://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.css" type="text/css" media="all" />
  <script src="http://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
  

  <!--
  todo: boostrap  http://v3.bootcss.com/
  code editor:https://github.com/codemirror/CodeMirror
  http://www.bootcdn.cn/codemirror/
  -->
  <!--bootstrap-->
  <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <!--<script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->

  <!--CodeMirror-->
  <link href="http://cdn.bootcss.com/codemirror/5.19.0/codemirror.css" rel="stylesheet">
  <script src="http://cdn.bootcss.com/codemirror/5.19.0/codemirror.js"></script>
  <link href="http://cdn.bootcss.com/codemirror/5.19.0/theme/solarized.min.css" rel="stylesheet">
  <script src="http://cdn.bootcss.com/codemirror/5.19.0/mode/python/python.min.js"></script>

  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>

<div class="row" style='margin:10px'>
  <div class="col-md-6"> <!--bootstrap栅格系统-->

  <h1>与物理世界交互</h1>
  <p>
  <button type="button" id='showCode' class="btn btn-lg btn-info" onclick="showCode()">显示代码</button> <!--todo:通过js设置disabled="disabled"-->
    <button type="button" id='runCode' class="btn btn-lg btn-primary" onclick="runCode()">运行代码</button>
  </p>

  <!--收集ip-->
  <form style='margin:10px' role="form" onsubmit="check_pi_access();return false;"> <!--点击后调用函数验证,直接回调 不要用jquery-->
  <div class="form-group">
    <label for="pi_ip">填写树莓派IP(可使用 ping  raspberrypi.local 获得)</label>
    <input autocomplete="on" autofocus required pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$" class="form-control" id="pi_ip" placeholder="192.168.0.127">
  </div>
  <button type="submit" type="button" class="btn btn-success" class="btn btn-default">连接树莓派</button> <!--树莓派那边写一个access,显示连接成功-->
  <!--help:ping  raspberrypi.local-->
  </form>

  <div  id="blocklyDiv" style="height: 480px; width: 600px;"></div>

  <xml id="toolbox" style="display: none">
    <category colour="210" name="树莓派">
      <block type="alphabet"></block>
      <block type="beep"></block>
      <block type="say"></block>
      <block type="train_your_ai"></block>
      <block type="talk_with_ai"></block>
      <block type="get_distance"></block>
      <block type="time_sleep"></block>
    </category>
    </category>
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>
  </xml>

  <xml id="startBlocks" style="display: none">
    <block type="controls_if" inline="false" x="20" y="20">
      <mutation else="1"></mutation>
      <value name="IF0">
        <block type="logic_compare" inline="true">
          <field name="OP">EQ</field>
          <value name="A">
            <block type="math_arithmetic" inline="true">
              <field name="OP">MULTIPLY</field>
              <value name="A">
                <block type="math_number">
                  <field name="NUM">6</field>
                </block>
              </value>
              <value name="B">
                <block type="math_number">
                  <field name="NUM">7</field>
                </block>
              </value>
            </block>
          </value>
          <value name="B">
            <block type="math_number">
              <field name="NUM">42</field>
            </block>
          </value>
        </block>
      </value>
      <statement name="DO0">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Don't panic</field>
            </block>
          </value>
        </block>
      </statement>
      <statement name="ELSE">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Panic</field>
            </block>
          </value>
        </block>
      </statement>
    </block>
  </xml>
</div><!--end col-md-6-->
  <div class="col-md-6">
   <divi id="code_playgroud">
   <h1>Code Generator  </h1>
   </div>
  </div>
</div> <!--end row-->

  <script>
    var workspace = Blockly.inject('blocklyDiv',
        {media: '../../media/',
         toolbox: document.getElementById('toolbox')});
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                               workspace);

    function wwjtest(code) {
      var ip = document.getElementById('pi_ip').value; //需要一个总的开始，填入ip
      var blockly_server = `http://${ip}:5000/run`; //run
      //code_base64 = window.btoa(unescape(encodeURIComponent( code )))
      code_base64 = code
      xmlhttp=new XMLHttpRequest();
      xmlhttp.timeout = 8000;//10秒 //异步才有
      xmlhttp.ontimeout = function (e) {
        swal('请求超时')
        document.getElementById("runCode").disabled = false;
      };
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
          code_result = JSON.parse(xmlhttp.response).code_result
           console.log(code_result);
          //sweetalert A beautiful replacement for JavaScript's "alert"
          document.getElementById("runCode").disabled = false;
          swal('运行结果:',code_result);
          };
        };
      xmlhttp.open("POST",blockly_server,true);//异步,同步是false
      xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      xmlhttp.send(JSON.stringify({key:"test",code:code_base64}));
      //弹出执行成功 
      
      //es6
      // var name = "wwj";
      //console.log(`hi, ${name}!`);
    }//end wwjtest


    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Python.workspaceToCode(workspace);
      //写入到codemirror里
      //editor.getValue(); 得到转义的
      //editor.getTextArea().value; 得到未转义的
      //editor.setValue('为codemirror赋值');
      myCodeMirror.setValue(code)
      //swal(code);
    }

    function runCode() {
      // Generate JavaScript code and run it.
      // 发送到硬件里
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      //get code from code code_playgroud
      
      var code = Blockly.Python.workspaceToCode(workspace);
      //var code = myCodeMirror.getValue();
      console.log(code);
      //设置按钮：document.getElementById("myBtn").disabled = true;
      document.getElementById("runCode").disabled = true;
      wwjtest(code);
      //1+5加号会没掉
      //alert(code);
    }

function  check_pi_access(){
      var ip = document.getElementById('pi_ip').value; //需要一个总的开始，填入ip
      var blockly_server = `http://${ip}:5000/access`; //access
      var xmlhttp=new XMLHttpRequest();
      xmlhttp.timeout = 3000;  //10秒 //异步才有
      xmlhttp.ontimeout = function (e) {
        swal('请求超时');
      };
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
           console.log("树莓派连接成功");
           swal("树莓派连接成功");
          };
      }
 
      xmlhttp.open("GET",blockly_server,true);//异步,同步是false
      xmlhttp.send();
}
  


  </script>

  <script type="text/javascript" charset="utf-8">
myCodeMirror = CodeMirror(document.getElementById("code_playgroud"), {
    lineNumbers: true,
    styleActiveLine: true,
    value: "def hello()\n    print 'hello world'\n",
      mode:  "python"
}); //全局
var theme="solarized dark";
myCodeMirror.setOption("theme", theme);
  </script>
</body>
</html>
